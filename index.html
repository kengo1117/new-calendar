<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>å‹‰å¼·ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 10px;
    }
    h1 {
      text-align: center;
    }
    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
    .day {
      background: #f3f3f3;
      border: 1px solid #ccc;
      padding: 10px;
      cursor: pointer;
      min-height: 80px;
      position: relative;
      font-size: 0.8em;
    }
    .note {
      font-size: 0.75em;
      color: #555;
    }
    .achieved {
      position: absolute;
      top: 5px;
      right: 5px;
      color: green;
      font-weight: bold;
    }
    #modal, #goalModal {
      display: none;
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border: 1px solid #ccc;
      padding: 20px;
      z-index: 10;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      border-radius: 10px;
    }
    #overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.3);
      z-index: 5;
    }
    label {
      display: block;
      margin: 8px 0 4px;
    }
    input, textarea, select {
      width: 100%;
      padding: 6px;
      margin-bottom: 10px;
    }
    button {
      padding: 6px 12px;
      margin: 4px;
    }
    #chartContainer {
      max-width: 400px;
      margin: 20px auto;
    }
    @media screen and (max-width: 600px) {
      .day {
        padding: 5px;
        min-height: 60px;
      }
    }
  </style>
</head>
<body>
  <h1>ğŸ“˜ å‹‰å¼·ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>
  <div style="text-align:center; margin-bottom: 10px;">
    <button onclick="prevMonth()">â† å‰æœˆ</button>
    <span id="monthYear"></span>
    <button onclick="nextMonth()">æ¬¡æœˆ â†’</button>
  </div>

  <!-- ğŸ¯ æœˆé–“ç›®æ¨™è¡¨ç¤º -->
  <div id="goalArea" style="margin-bottom: 10px; text-align:center;">
    <div>ğŸ¯ ä»Šæœˆã®ç›®æ¨™: <span id="goalText">(æœªè¨­å®š)</span></div>
    <button onclick="openGoalModal()">âœï¸ ç›®æ¨™ã‚’è¨­å®š</button>
  </div>

  <!-- ğŸ“¤ğŸ“¥ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
  <div style="text-align: center; margin-bottom: 10px;">
    <button onclick="exportData()">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    <input type="file" id="importFile" style="display:none;" onchange="importData(event)">
    <button onclick="document.getElementById('importFile').click()">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
  </div>

  <div id="calendar"></div>

  <div id="chartContainer">
    <canvas id="achievementChart"></canvas>
  </div>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå‹‰å¼·è¨˜éŒ²ï¼‰ -->
  <div id="modal">
    <h3 id="modalDate"></h3>
    <label>æ•™ç§‘</label>
    <input type="text" id="subject">
    <label>äºˆå®šï¼ˆå†…å®¹ï¼‰</label>
    <textarea id="planNote"></textarea>
    <label>å®Ÿç¸¾ï¼ˆå†…å®¹ï¼‰</label>
    <textarea id="actualNote"></textarea>
    <label>äºˆå®šé€šã‚Šã§ããŸï¼Ÿ</label>
    <input type="checkbox" id="achieved">
    <div style="text-align:center;">
      <button onclick="saveData()">ä¿å­˜</button>
      <button onclick="closeModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæœˆç›®æ¨™ï¼‰ -->
  <div id="goalModal">
    <h3>ğŸ¯ ä»Šæœˆã®ç›®æ¨™ã‚’å…¥åŠ›</h3>
    <textarea id="goalInput" rows="4"></textarea>
    <div style="text-align:center;">
      <button onclick="saveGoal()">ä¿å­˜</button>
      <button onclick="closeGoalModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="overlay" onclick="closeModal(); closeGoalModal();"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let currentDate = new Date();
    const calendar = document.getElementById("calendar");
    const monthYear = document.getElementById("monthYear");

    function buildCalendar() {
      calendar.innerHTML = '';
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      monthYear.textContent = `${year}å¹´ ${month + 1}æœˆ`;

      const firstDay = new Date(year, month, 1).getDay();
      const lastDate = new Date(year, month + 1, 0).getDate();
      let achievedCount = 0;

      for (let i = 0; i < firstDay; i++) {
        calendar.innerHTML += `<div></div>`;
      }

      for (let d = 1; d <= lastDate; d++) {
        const dateKey = `${year}-${month + 1}-${d}`;
        const data = JSON.parse(localStorage.getItem(dateKey) || '{}');
        const subj = data.subject || '';
        const plan = data.planNote || '';
        const done = data.achieved;

        if (done) achievedCount++;

        calendar.innerHTML += `
          <div class="day" onclick="openModal('${dateKey}')">
            ${d}
            ${subj ? `<div class="note">ğŸ“˜ ${subj}</div>` : ''}
            ${plan ? `<div class="note">ğŸ“ ${plan.slice(0, 20)}â€¦</div>` : ''}
            ${done ? `<div class="achieved">âœ…</div>` : ''}
          </div>`;
      }

      const rate = Math.round((achievedCount / lastDate) * 100);
      updateChart(rate);
      loadGoal();
    }

    function prevMonth() {
      currentDate.setMonth(currentDate.getMonth() - 1);
      buildCalendar();
    }

    function nextMonth() {
      currentDate.setMonth(currentDate.getMonth() + 1);
      buildCalendar();
    }

    let currentKey = "";
    function openModal(key) {
      currentKey = key;
      const data = JSON.parse(localStorage.getItem(key) || '{}');
      document.getElementById("modalDate").textContent = key;
      document.getElementById("subject").value = data.subject || '';
      document.getElementById("planNote").value = data.planNote || '';
      document.getElementById("actualNote").value = data.actualNote || '';
      document.getElementById("achieved").checked = data.achieved || false;
      document.getElementById("modal").style.display = 'block';
      document.getElementById("overlay").style.display = 'block';
    }

    function closeModal() {
      document.getElementById("modal").style.display = 'none';
      document.getElementById("overlay").style.display = 'none';
    }

    function saveData() {
      const data = {
        subject: document.getElementById("subject").value,
        planNote: document.getElementById("planNote").value,
        actualNote: document.getElementById("actualNote").value,
        achieved: document.getElementById("achieved").checked
      };
      localStorage.setItem(currentKey, JSON.stringify(data));
      closeModal();
      buildCalendar();
    }

    function getMonthKey() {
      return `${currentDate.getFullYear()}-${currentDate.getMonth() + 1}`;
    }

    function openGoalModal() {
      const key = "goal-" + getMonthKey();
      document.getElementById("goalInput").value = localStorage.getItem(key) || "";
      document.getElementById("goalModal").style.display = "block";
      document.getElementById("overlay").style.display = "block";
    }

    function closeGoalModal() {
      document.getElementById("goalModal").style.display = "none";
      document.getElementById("overlay").style.display = "none";
    }

    function saveGoal() {
      const key = "goal-" + getMonthKey();
      localStorage.setItem(key, document.getElementById("goalInput").value);
      closeGoalModal();
      loadGoal();
    }

    function loadGoal() {
      const key = "goal-" + getMonthKey();
      document.getElementById("goalText").textContent = localStorage.getItem(key) || "(æœªè¨­å®š)";
    }

    // ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    function exportData() {
      const allData = {};
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith("goal-") || key.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
          allData[key] = localStorage.getItem(key);
        }
      }
      const blob = new Blob([JSON.stringify(allData, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "study_data_backup.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    // ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          for (const [k, v] of Object.entries(data)) {
            localStorage.setItem(k, v);
          }
          alert("ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚");
          location.reload();
        } catch (e) {
          alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }
      };
      reader.readAsText(file);
    }

    // ğŸ“Š é”æˆç‡ã‚°ãƒ©ãƒ•
    let chart;
    function updateChart(rate) {
      const ctx = document.getElementById("achievementChart").getContext("2d");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['é”æˆç‡', 'æœªé”æˆ'],
          datasets: [{
            data: [rate, 100 - rate],
            backgroundColor: ['#4caf50', '#e0e0e0']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: true
            }
          }
        }
      });
    }

    buildCalendar();
  </script>
</body>
</html>


