<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>勉強カレンダー</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 10px;
    }
    h1 {
      text-align: center;
    }
    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
    .day {
      background: #f3f3f3;
      border: 1px solid #ccc;
      padding: 10px;
      cursor: pointer;
      min-height: 80px;
      position: relative;
      font-size: 0.8em;
    }
    .note {
      font-size: 0.75em;
      color: #555;
    }
    .achieved {
      position: absolute;
      top: 5px;
      right: 5px;
      color: green;
      font-weight: bold;
    }
    #modal, #goalModal {
      display: none;
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border: 1px solid #ccc;
      padding: 20px;
      z-index: 10;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      border-radius: 10px;
    }
    #overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.3);
      z-index: 5;
    }
    label {
      display: block;
      margin: 8px 0 4px;
    }
    input, textarea, select {
      width: 100%;
      padding: 6px;
      margin-bottom: 10px;
    }
    button {
      padding: 6px 12px;
      margin: 4px;
    }
    #chartContainer {
      max-width: 400px;
      margin: 20px auto;
    }
    @media screen and (max-width: 600px) {
      .day {
        padding: 5px;
        min-height: 60px;
      }
    }
  </style>
</head>
<body>
  <h1>📘 勉強カレンダー</h1>
  <div style="text-align:center; margin-bottom: 10px;">
    <button onclick="prevMonth()">← 前月</button>
    <span id="monthYear"></span>
    <button onclick="nextMonth()">次月 →</button>
  </div>

  <!-- 🎯 月間目標表示 -->
  <div id="goalArea" style="margin-bottom: 10px; text-align:center;">
    <div>🎯 今月の目標: <span id="goalText">(未設定)</span></div>
    <button onclick="openGoalModal()">✏️ 目標を設定</button>
  </div>

  <!-- 📤📥 エクスポート/インポート -->
  <div style="text-align: center; margin-bottom: 10px;">
    <button onclick="exportData()">📤 データをエクスポート</button>
    <input type="file" id="importFile" style="display:none;" onchange="importData(event)">
    <button onclick="document.getElementById('importFile').click()">📥 インポート</button>
  </div>

  <div id="calendar"></div>

  <div id="chartContainer">
    <canvas id="achievementChart"></canvas>
  </div>

  <!-- モーダル（勉強記録） -->
  <div id="modal">
    <h3 id="modalDate"></h3>
    <label>教科</label>
    <input type="text" id="subject">
    <label>予定（内容）</label>
    <textarea id="planNote"></textarea>
    <label>実績（内容）</label>
    <textarea id="actualNote"></textarea>
    <label>予定通りできた？</label>
    <input type="checkbox" id="achieved">
    <div style="text-align:center;">
      <button onclick="saveData()">保存</button>
      <button onclick="closeModal()">閉じる</button>
    </div>
  </div>

  <!-- モーダル（月目標） -->
  <div id="goalModal">
    <h3>🎯 今月の目標を入力</h3>
    <textarea id="goalInput" rows="4"></textarea>
    <div style="text-align:center;">
      <button onclick="saveGoal()">保存</button>
      <button onclick="closeGoalModal()">閉じる</button>
    </div>
  </div>

  <div id="overlay" onclick="closeModal(); closeGoalModal();"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let currentDate = new Date();
    const calendar = document.getElementById("calendar");
    const monthYear = document.getElementById("monthYear");

    function buildCalendar() {
      calendar.innerHTML = '';
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      monthYear.textContent = `${year}年 ${month + 1}月`;

      const firstDay = new Date(year, month, 1).getDay();
      const lastDate = new Date(year, month + 1, 0).getDate();
      let achievedCount = 0;

      for (let i = 0; i < firstDay; i++) {
        calendar.innerHTML += `<div></div>`;
      }

      for (let d = 1; d <= lastDate; d++) {
        const dateKey = `${year}-${month + 1}-${d}`;
        const data = JSON.parse(localStorage.getItem(dateKey) || '{}');
        const subj = data.subject || '';
        const plan = data.planNote || '';
        const done = data.achieved;

        if (done) achievedCount++;

        calendar.innerHTML += `
          <div class="day" onclick="openModal('${dateKey}')">
            ${d}
            ${subj ? `<div class="note">📘 ${subj}</div>` : ''}
            ${plan ? `<div class="note">📝 ${plan.slice(0, 20)}…</div>` : ''}
            ${done ? `<div class="achieved">✅</div>` : ''}
          </div>`;
      }

      const rate = Math.round((achievedCount / lastDate) * 100);
      updateChart(rate);
      loadGoal();
    }

    function prevMonth() {
      currentDate.setMonth(currentDate.getMonth() - 1);
      buildCalendar();
    }

    function nextMonth() {
      currentDate.setMonth(currentDate.getMonth() + 1);
      buildCalendar();
    }

    let currentKey = "";
    function openModal(key) {
      currentKey = key;
      const data = JSON.parse(localStorage.getItem(key) || '{}');
      document.getElementById("modalDate").textContent = key;
      document.getElementById("subject").value = data.subject || '';
      document.getElementById("planNote").value = data.planNote || '';
      document.getElementById("actualNote").value = data.actualNote || '';
      document.getElementById("achieved").checked = data.achieved || false;
      document.getElementById("modal").style.display = 'block';
      document.getElementById("overlay").style.display = 'block';
    }

    function closeModal() {
      document.getElementById("modal").style.display = 'none';
      document.getElementById("overlay").style.display = 'none';
    }

    function saveData() {
      const data = {
        subject: document.getElementById("subject").value,
        planNote: document.getElementById("planNote").value,
        actualNote: document.getElementById("actualNote").value,
        achieved: document.getElementById("achieved").checked
      };
      localStorage.setItem(currentKey, JSON.stringify(data));
      closeModal();
      buildCalendar();
    }

    function getMonthKey() {
      return `${currentDate.getFullYear()}-${currentDate.getMonth() + 1}`;
    }

    function openGoalModal() {
      const key = "goal-" + getMonthKey();
      document.getElementById("goalInput").value = localStorage.getItem(key) || "";
      document.getElementById("goalModal").style.display = "block";
      document.getElementById("overlay").style.display = "block";
    }

    function closeGoalModal() {
      document.getElementById("goalModal").style.display = "none";
      document.getElementById("overlay").style.display = "none";
    }

    function saveGoal() {
      const key = "goal-" + getMonthKey();
      localStorage.setItem(key, document.getElementById("goalInput").value);
      closeGoalModal();
      loadGoal();
    }

    function loadGoal() {
      const key = "goal-" + getMonthKey();
      document.getElementById("goalText").textContent = localStorage.getItem(key) || "(未設定)";
    }

    // 📤 エクスポート
    function exportData() {
      const allData = {};
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith("goal-") || key.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
          allData[key] = localStorage.getItem(key);
        }
      }
      const blob = new Blob([JSON.stringify(allData, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "study_data_backup.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    // 📥 インポート
    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          for (const [k, v] of Object.entries(data)) {
            localStorage.setItem(k, v);
          }
          alert("インポート完了！ページを再読み込みします。");
          location.reload();
        } catch (e) {
          alert("読み込みに失敗しました。ファイルを確認してください。");
        }
      };
      reader.readAsText(file);
    }

    // 📊 達成率グラフ
    let chart;
    function updateChart(rate) {
      const ctx = document.getElementById("achievementChart").getContext("2d");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['達成率', '未達成'],
          datasets: [{
            data: [rate, 100 - rate],
            backgroundColor: ['#4caf50', '#e0e0e0']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: true
            }
          }
        }
      });
    }

    buildCalendar();
  </script>
</body>
</html>


