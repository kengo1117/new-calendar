<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>学習カレンダー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 10px;
      background: #f9f9f9;
    }
    h1 {
      text-align: center;
    }
    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      max-width: 600px;
      margin: 0 auto;
    }
    .day {
      background: white;
      padding: 10px;
      min-height: 80px;
      border: 1px solid #ccc;
      border-radius: 5px;
      position: relative;
      font-size: 0.9em;
    }
    .day-header {
      font-weight: bold;
      text-align: center;
    }
    .subject {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      color: white;
      font-size: 0.8em;
    }
    .Math { background-color: #4caf50; }
    .Science { background-color: #2196f3; }
    .English { background-color: #ff9800; }
    .History { background-color: #9c27b0; }
    .Achieved {
      text-decoration: line-through;
      opacity: 0.6;
    }
    #goalModal, #dailyGoalModal, #goalInputModal {
      display: none;
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 20px;
      border: 1px solid #aaa;
      z-index: 1001;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
    }
    #graph {
      max-width: 600px;
      margin: 20px auto;
    }
    canvas {
      width: 100% !important;
      height: auto !important;
    }
    #overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      z-index: 1000;
    }
    @media (max-width: 600px) {
      .day { font-size: 0.8em; }
    }
  </style>
</head>
<body>
  <h1>📘 学習カレンダー</h1>
  <div id="goalArea" style="text-align: center; margin-bottom: 10px;">
    🎯 今月の目標: <span id="goalText">(未設定)</span>
    <button onclick="openGoalModal()">✏️ 設定</button>
  </div>
  <div id="dailyGoalArea" style="text-align: center; margin-bottom: 10px;">
    🗓️ 今日の目標: <span id="dailyGoalText">(未設定)</span>
    <button onclick="openDailyGoalModal()">✏️ 設定</button>
  </div>
  <div id="calendar"></div>
  <div id="graph">
    <canvas id="achieveChart"></canvas>
  </div>
  <div style="text-align: center; margin-top: 20px;">
    <a href="links.html" style="padding: 10px 20px; background-color: #28a745; color: white; border-radius: 8px; text-decoration: none;">🔗 リンク一覧</a>
  </div>

  <div id="goalModal">
    <h3>🎯 今月の目標</h3>
    <textarea id="goalInput" rows="4" style="width: 100%;"></textarea>
    <div style="text-align:center; margin-top:10px;">
      <button onclick="saveGoal()">保存</button>
      <button onclick="closeGoalModal()">閉じる</button>
    </div>
  </div>

  <div id="dailyGoalModal">
    <h3>🗓️ 今日の目標</h3>
    <textarea id="dailyGoalInput" rows="3" style="width: 100%;"></textarea>
    <div style="text-align:center; margin-top:10px;">
      <button onclick="saveDailyGoal()">保存</button>
      <button onclick="closeDailyGoalModal()">閉じる</button>
    </div>
  </div>

  <div id="overlay"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const subjects = ["Math", "Science", "English", "History"];

    function getMonthKey() {
      const today = new Date();
      return today.getFullYear() + "-" + (today.getMonth() + 1);
    }

    function getTodayKey() {
      const today = new Date();
      return `dailyGoal-${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
    }

    function buildCalendar() {
      const calendar = document.getElementById("calendar");
      calendar.innerHTML = "";
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth();
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      const headers = ["日", "月", "火", "水", "木", "金", "土"];
      headers.forEach(h => {
        const div = document.createElement("div");
        div.textContent = h;
        div.className = "day-header";
        calendar.appendChild(div);
      });

      for (let i = 0; i < firstDay; i++) {
        calendar.appendChild(document.createElement("div"));
      }

      const key = getMonthKey();
      const saved = JSON.parse(localStorage.getItem("studyData-" + key) || "{}");

      for (let d = 1; d <= daysInMonth; d++) {
        const div = document.createElement("div");
        div.className = "day";
        const dateKey = d;
        div.innerHTML = `<strong>${d}</strong><br/>`;
        if (saved[dateKey]) {
          saved[dateKey].forEach(entry => {
            const span = document.createElement("span");
            span.className = `subject ${entry.subject}`;
            span.textContent = `${entry.subject}: ${entry.time}分`;
            if (entry.done) span.classList.add("Achieved");
            div.appendChild(document.createElement("br"));
            div.appendChild(span);
          });
        }
        calendar.appendChild(div);
      }
      loadGoal();
      loadDailyGoal();
      updateGraph();
    }

    function openGoalModal() {
      document.getElementById("goalInput").value = localStorage.getItem("goal-" + getMonthKey()) || "";
      document.getElementById("goalModal").style.display = "block";
      document.getElementById("overlay").style.display = "block";
    }
    function closeGoalModal() {
      document.getElementById("goalModal").style.display = "none";
      document.getElementById("overlay").style.display = "none";
    }
    function saveGoal() {
      localStorage.setItem("goal-" + getMonthKey(), document.getElementById("goalInput").value);
      closeGoalModal();
      loadGoal();
    }
    function loadGoal() {
      document.getElementById("goalText").textContent = localStorage.getItem("goal-" + getMonthKey()) || "(未設定)";
    }

    function openDailyGoalModal() {
      document.getElementById("dailyGoalInput").value = localStorage.getItem(getTodayKey()) || "";
      document.getElementById("dailyGoalModal").style.display = "block";
      document.getElementById("overlay").style.display = "block";
    }
    function closeDailyGoalModal() {
      document.getElementById("dailyGoalModal").style.display = "none";
      document.getElementById("overlay").style.display = "none";
    }
    function saveDailyGoal() {
      localStorage.setItem(getTodayKey(), document.getElementById("dailyGoalInput").value);
      closeDailyGoalModal();
      loadDailyGoal();
    }
    function loadDailyGoal() {
      document.getElementById("dailyGoalText").textContent = localStorage.getItem(getTodayKey()) || "(未設定)";
    }

    function updateGraph() {
      const key = getMonthKey();
      const saved = JSON.parse(localStorage.getItem("studyData-" + key) || "{}");
      let achieved = 0, total = 0;
      for (let d in saved) {
        saved[d].forEach(e => {
          total++;
          if (e.done) achieved++;
        });
      }
      const ctx = document.getElementById("achieveChart").getContext("2d");
      new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["達成", "未達成"],
          datasets: [{
            data: [achieved, total - achieved],
            backgroundColor: ["#4caf50", "#ccc"]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: "bottom"
            },
            title: {
              display: true,
              text: "今月の達成率"
            }
          }
        }
      });
    }

    window.onload = buildCalendar;
  </script>
</body>
</html>



